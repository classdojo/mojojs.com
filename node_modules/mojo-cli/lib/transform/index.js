var through = require("through"),
fs          = require("fs"),
path        = require("path");



module.exports = function (transformers) {

  function transformer (scriptPath) {
    var buffer = [];

    return through(write, end);

    function write (chunk) {
      buffer.push(chunk);
    }

    function end () {
      var i, content = buffer.join(""), transformer;

      for(i = transformers.length; i--;) {
        transformer  = transformers[i];
        if(scriptPath.split(".").pop() == transformer.extension) {
          try {
            content = transformer.transform(content, scriptPath);
          } catch (e) {
            console.error("unable to process %s", scriptPath);
            console.error(e.stack);
          }
          break;
        };
      }

      this.queue(content);
      this.queue(null);
    }
  }

  transformer.extensions = transformers.map(function(transformer) {
    return "." + transformer.extension;
  });

  return transformer;
    
};

